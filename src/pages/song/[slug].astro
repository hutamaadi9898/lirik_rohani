---
import BaseLayout from '../../layouts/BaseLayout.astro';

export const prerender = false;

const slug = Astro.params.slug!;
const runtime = Astro.locals.runtime;
const env = runtime?.env as Env | undefined;

type SongRow = {
  id: string;
  title: unknown;
  artist: unknown;
  language: unknown;
  body_text: unknown;
  slug: string;
  created_at: number;
  updated_at: number;
};

let song: SongRow | null = null;

if (env?.LYRICS_DB) {
  song = await env.LYRICS_DB.prepare(
    `SELECT
       id,
       title,
       artist,
       language,
       -- Normalize body to text to avoid "[object Object]" or JSON blobs
       CASE
         WHEN typeof(body) = 'text' THEN body
         WHEN json_valid(body) THEN json_extract(body, '$')
         ELSE CAST(body AS TEXT)
       END AS body_text,
       slug,
       created_at,
       updated_at
     FROM songs
     WHERE slug = ?
     LIMIT 1;`,
  )
    .bind(slug)
    .first();
}

if (!song) {
  return Astro.redirect('/404');
}

const visited = new WeakSet<object>();

const toStrings = (value: unknown): string[] => {
  if (value === null || value === undefined) return [];

  if (typeof value === 'string') {
    const trimmed = value.trim();
    if (!trimmed || trimmed === '[object Object]' || trimmed === '"[object Object]"') return [];

    const looksJson =
      (trimmed.startsWith('{') && trimmed.endsWith('}')) ||
      (trimmed.startsWith('[') && trimmed.endsWith(']')) ||
      (trimmed.startsWith('"') && trimmed.endsWith('"'));

    if (looksJson) {
      try {
        return toStrings(JSON.parse(trimmed));
      } catch {
        /* fall back to raw string */
      }
    }

    return trimmed
      .split(/\r?\n/)
      .map((line) => line.trimEnd())
      .filter((line) => line !== '[object Object]');
  }

  if (Array.isArray(value)) {
    return value.flatMap((entry) => toStrings(entry));
  }

  if (typeof value === 'object') {
    if (visited.has(value as object)) return [];
    visited.add(value as object);

    const obj = value as Record<string, unknown>;
    const preferred = ['body', 'text', 'lyrics', 'lines', 'verses', 'chorus', 'bridge', 'refrain', 'content'];
    for (const key of preferred) {
      if (key in obj) {
        const nested = toStrings(obj[key]);
        if (nested.length) return nested;
      }
    }

    return Object.values(obj).flatMap((entry) => toStrings(entry));
  }

  const str = String(value);
  if (!str || str === '[object Object]') return [];
  return [str];
};

const coerceBody = (raw: unknown): string => toStrings(raw).join('\n');

const titleText = typeof song.title === 'string' ? song.title : String(song.title ?? '');
const artistText = (() => {
  if (!song.artist) return null;
  if (typeof song.artist === 'string') return song.artist;
  const picked = toStrings(song.artist)[0];
  return picked ?? JSON.stringify(song.artist);
})();
const languageText = typeof song.language === 'string' && song.language.trim() ? song.language : 'id';

const bodyText = coerceBody(song.body_text);
const pageTitle = `${titleText} â€” Lirik Rohani`;
const description = artistText
  ? `Lirik "${titleText}" oleh ${artistText}`
  : `Lirik "${titleText}"`;

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'MusicRecording',
  name: titleText,
  inLanguage: languageText,
  byArtist: artistText ? { '@type': 'MusicGroup', name: artistText } : undefined,
  url: `${Astro.url.origin}/song/${song.slug}`,
  datePublished: new Date((song.created_at ?? 0) * 1000).toISOString(),
  dateModified: new Date((song.updated_at ?? song.created_at ?? 0) * 1000).toISOString(),
};
---

<BaseLayout title={pageTitle} description={description}>
  <article class="space-y-6 rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-lg shadow-cyan-500/5">
    <header class="space-y-2">
      <p class="text-xs uppercase tracking-[0.2em] text-cyan-300/80">Lirik Lagu Rohani</p>
      <h1 class="text-3xl font-semibold text-slate-50">{titleText}</h1>
      {artistText && <p class="text-sm text-slate-400">oleh {artistText}</p>}
    </header>
    <div class="prose prose-invert max-w-none leading-relaxed text-slate-100">
      {bodyText
        ? bodyText.split(/\r?\n/).map((line) => <p>{line || '\u00a0'}</p>)
        : <p class="italic text-slate-400">Lirik belum tersedia.</p>}
    </div>
  </article>

  <script type="application/ld+json">
    {JSON.stringify(jsonLd)}
  </script>
</BaseLayout>
