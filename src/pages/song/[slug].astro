---
import BaseLayout from '../../layouts/BaseLayout.astro';

export const prerender = false;

const slug = Astro.params.slug!;
const runtime = Astro.locals.runtime;
const env = runtime?.env as Env | undefined;

type SongRow = {
  id: string;
  title: string;
  artist: string | null;
  language: string | null;
  body_text: string | null;
  slug: string;
  created_at: number;
  updated_at: number;
};

let song: SongRow | null = null;

if (env?.LYRICS_DB) {
  song = await env.LYRICS_DB.prepare(
    `SELECT
       id,
       title,
       artist,
       language,
       -- Normalize body to text to avoid "[object Object]" or JSON blobs
       CASE
         WHEN typeof(body) = 'text' THEN body
         WHEN json_valid(body) THEN json_extract(body, '$')
         ELSE CAST(body AS TEXT)
       END AS body_text,
       slug,
       created_at,
       updated_at
     FROM songs
     WHERE slug = ?
     LIMIT 1;`,
  )
    .bind(slug)
    .first();
}

if (!song) {
  return Astro.redirect('/404');
}

const coerceBody = (raw: unknown): string => {
  const normalizeString = (val: string) => {
    const trimmed = val.trim();
    if (!trimmed) return '';
    if (trimmed === '[object Object]') return '';
    if (trimmed.startsWith('["') && trimmed.endsWith('"]')) {
      // JSON array of lines as string
      try {
        const arr = JSON.parse(trimmed) as unknown;
        if (Array.isArray(arr)) return arr.filter((x) => typeof x === 'string').join('\n');
      } catch {
        /* ignore */
      }
    }
    // Try to decode JSON string
    try {
      const parsed = JSON.parse(trimmed) as unknown;
      if (typeof parsed === 'string') return parsed;
      if (Array.isArray(parsed)) return parsed.filter((x) => typeof x === 'string').join('\n');
      if (parsed && typeof parsed === 'object') {
        // @ts-expect-error dynamic lookup
        if (typeof parsed.body === 'string') return parsed.body;
        // @ts-expect-error dynamic lookup
        if (typeof parsed.text === 'string') return parsed.text;
      }
    } catch {
      /* not JSON, use raw */
    }
    return trimmed;
  };

  if (typeof raw === 'string') return normalizeString(raw);

  if (Array.isArray(raw)) {
    return raw.filter((x) => typeof x === 'string').join('\n');
  }

  if (raw && typeof raw === 'object') {
    // @ts-expect-error dynamic lookup
    if (typeof raw.body === 'string') return normalizeString(raw.body);
    // @ts-expect-error dynamic lookup
    if (Array.isArray(raw.body)) return raw.body.filter((x) => typeof x === 'string').join('\n');
    // @ts-expect-error dynamic lookup
    if (typeof raw.text === 'string') return normalizeString(raw.text);
    try {
      return JSON.stringify(raw, null, 2);
    } catch {
      return String(raw ?? '');
    }
  }

  return '';
};

const bodyText = coerceBody(song.body_text);
const pageTitle = `${song.title} â€” Lirik Rohani`;
const description = song.artist
  ? `Lirik "${song.title}" oleh ${song.artist}`
  : `Lirik "${song.title}"`;

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'MusicRecording',
  name: song.title,
  inLanguage: song.language ?? 'id',
  byArtist: song.artist ? { '@type': 'MusicGroup', name: song.artist } : undefined,
  url: `${Astro.url.origin}/song/${song.slug}`,
  datePublished: new Date((song.created_at ?? 0) * 1000).toISOString(),
  dateModified: new Date((song.updated_at ?? song.created_at ?? 0) * 1000).toISOString(),
};
---

<BaseLayout title={pageTitle} description={description}>
  <article class="space-y-6 rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-lg shadow-cyan-500/5">
    <header class="space-y-2">
      <p class="text-xs uppercase tracking-[0.2em] text-cyan-300/80">Lirik Lagu Rohani</p>
      <h1 class="text-3xl font-semibold text-slate-50">{song.title}</h1>
      {song.artist && <p class="text-sm text-slate-400">oleh {song.artist}</p>}
    </header>
    <div class="prose prose-invert max-w-none leading-relaxed text-slate-100">
      {bodyText
        ? bodyText.split(/\r?\n/).map((line) => <p>{line || '\u00a0'}</p>)
        : <p class="italic text-slate-400">Lirik belum tersedia.</p>}
    </div>
  </article>

  <script type="application/ld+json">
    {JSON.stringify(jsonLd)}
  </script>
</BaseLayout>
